<!DOCTYPE html>
<html>
<head>
    <title>Game - Bazillionaire</title>
    <style>
        body {
            margin: 0;
            font-family: monospace;
            background: #f0f0f0;
            color: #111;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #status {
            padding: 6px 10px;
            font-weight: bold;
            background: #fff;
            border-bottom: 3px solid #111;
        }
        #players {
            display: flex;
            flex-direction: row;
            gap: 0;
            padding: 12px 12px 0;
            overflow-x: auto;
        }
        .player-box {
            background: #fff;
            border: 3px solid #111;
            margin-right: -3px;
            padding: 12px 16px;
            font-family: monospace;
            min-width: 140px;
        }
        .player-name {
            font-size: 13px;
            font-weight: bold;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }
        .player-cash {
            font-size: 16px;
            font-weight: 900;
        }
        .player-holdings {
            font-size: 12px;
            color: #555;
            margin-top: 4px;
        }
        #tickers {
            display: flex;
            flex-direction: column;
            gap: 0;
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        .ticker-box {
            background: #fff;
            border: 3px solid #111;
            margin-bottom: -3px;
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .ticker-symbol {
            font-size: 14px;
            font-weight: bold;
            align-self: flex-start;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .ticker-price {
            font-size: 48px;
            font-weight: 900;
            line-height: 1;
            padding: 8px 0 4px;
        }
        .ticker-price.up { color: #0a8f3f; }
        .ticker-price.down { color: #d62828; }
        .ticker-buttons {
            display: flex;
            flex-direction: row;
            gap: 8px;
            margin-top: 8px;
        }
        .btn-buy, .btn-sell {
            font-family: monospace;
            font-weight: bold;
            font-size: 14px;
            padding: 6px 18px;
            border: 3px solid #111;
            border-radius: 0;
            cursor: pointer;
            color: #fff;
        }
        .btn-buy { background: #0a8f3f; }
        .btn-sell { background: #d62828; }
        .ticker-chart {
            width: 100%;
            height: 80px;
            display: block;
        }
        #logs-toggle {
            display: block;
            width: 100%;
            padding: 6px 10px;
            font-family: monospace;
            font-weight: bold;
            font-size: 13px;
            background: #222;
            color: #aaa;
            border: none;
            border-top: 3px solid #111;
            cursor: pointer;
            text-align: left;
        }
        #logs-toggle:hover {
            background: #333;
        }
        #logs {
            display: none;
            height: 200px;
            min-height: 100px;
        }
        #logs.open {
            display: flex;
        }
        #log-events, #log-tickers {
            flex: 1;
            background: #111;
            font-family: monospace;
            font-size: 13px;
            padding: 10px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        #log-events {
            color: #0f0;
            border-right: 2px solid #333;
        }
        #log-tickers {
            color: #aaa;
        }
    </style>
</head>
<body>
    <p id="status">Connecting...</p>
    <div id="players"></div>
    <div id="tickers"></div>
    <button id="logs-toggle">Logs &#x25B6;</button>
    <div id="logs">
        <div id="log-events"></div>
        <div id="log-tickers"></div>
    </div>

    <div id="game-data" data-game-id="{gameId}" data-player-id="{playerId}"></div>
    <script src="/js/ticker-chart.js"></script>
    <script>
    (function() {
        var el = document.getElementById('game-data');
        var gameId = el.dataset.gameId;
        var playerId = el.dataset.playerId;
        var logEvents = document.getElementById('log-events');
        var logTickers = document.getElementById('log-tickers');
        var status = document.getElementById('status');
        var tickersEl = document.getElementById('tickers');

        var prices = {};
        var prevPrices = {};
        var charts = {};
        var hoveredSymbol = null;
        var playersEl = document.getElementById('players');

        function formatPrice(cents) {
            return '$' + (cents / 100).toFixed(2);
        }

        function renderPlayers(players) {
            playersEl.innerHTML = '';
            var ids = Object.keys(players).sort();
            for (var i = 0; i < ids.length; i++) {
                var id = ids[i];
                var p = players[id];
                var box = document.createElement('div');
                box.className = 'player-box';

                var nameEl = document.createElement('div');
                nameEl.className = 'player-name';
                nameEl.textContent = id;

                var cashEl = document.createElement('div');
                cashEl.className = 'player-cash';
                cashEl.textContent = formatPrice(p.cashBalance);

                var holdingsEl = document.createElement('div');
                holdingsEl.className = 'player-holdings';
                var syms = Object.keys(p.holdings).filter(function(s) { return p.holdings[s] > 0; }).sort();
                holdingsEl.textContent = syms.length > 0
                    ? syms.map(function(s) { return s + ': ' + p.holdings[s]; }).join('  ')
                    : 'no shares';

                box.appendChild(nameEl);
                box.appendChild(cashEl);
                box.appendChild(holdingsEl);
                playersEl.appendChild(box);
            }
        }

        function renderTickers() {
            tickersEl.innerHTML = '';
            var symbols = Object.keys(prices).sort();
            for (var i = 0; i < symbols.length; i++) {
                var sym = symbols[i];
                var box = document.createElement('div');
                box.className = 'ticker-box';
                box.onmouseenter = (function(s) { return function() { hoveredSymbol = s; }; })(sym);
                box.onmouseleave = function() { hoveredSymbol = null; };

                var nameEl = document.createElement('span');
                nameEl.className = 'ticker-symbol';
                nameEl.textContent = sym;

                var priceEl = document.createElement('span');
                priceEl.className = 'ticker-price';
                var prev = prevPrices[sym];
                if (prev !== undefined && prices[sym] > prev) priceEl.classList.add('up');
                else if (prev !== undefined && prices[sym] < prev) priceEl.classList.add('down');
                priceEl.textContent = formatPrice(prices[sym]);

                var btnsEl = document.createElement('div');
                btnsEl.className = 'ticker-buttons';

                var buyBtn = document.createElement('button');
                buyBtn.className = 'btn-buy';
                buyBtn.textContent = 'BUY';
                buyBtn.onclick = (function(s) {
                    return function() {
                        ws.send(JSON.stringify({ type: 'BUY', payload: { ticker: s, price: prices[s] } }));
                    };
                })(sym);

                var sellBtn = document.createElement('button');
                sellBtn.className = 'btn-sell';
                sellBtn.textContent = 'SELL';
                sellBtn.onclick = (function(s) {
                    return function() {
                        ws.send(JSON.stringify({ type: 'SELL', payload: { ticker: s, price: prices[s] } }));
                    };
                })(sym);

                btnsEl.appendChild(buyBtn);
                btnsEl.appendChild(sellBtn);

                var canvas = document.createElement('canvas');
                canvas.className = 'ticker-chart';
                canvas.width = 400;
                canvas.height = 80;

                box.appendChild(nameEl);
                box.appendChild(priceEl);
                box.appendChild(canvas);
                box.appendChild(btnsEl);
                tickersEl.appendChild(box);

                if (!charts[sym]) {
                    charts[sym] = new TickerChart(canvas);
                } else {
                    charts[sym].canvas = canvas;
                    charts[sym].ctx = canvas.getContext('2d');
                }
                charts[sym].render();
            }
        }

        function appendLog(target, text) {
            var line = document.createElement('div');
            line.textContent = text;
            target.appendChild(line);
            target.scrollTop = target.scrollHeight;
        }

        var protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        var ws = new WebSocket(protocol + '//' + location.host + '/game/' + gameId);

        ws.onopen = function() {
            status.textContent = 'Connected. Joining...';
            ws.send(JSON.stringify({ type: 'JOIN', payload: { playerId: playerId } }));
        };

        ws.onmessage = function(event) {
            status.textContent = 'Connected';
            var msg = JSON.parse(event.data);

            if (msg.type === 'PLAYERS_STATE') {
                renderPlayers(msg.data.players);
            } else if (msg.type === 'GAME_STATE') {
                prevPrices = Object.assign({}, prices);
                prices = msg.data.prices;
                renderTickers();
                var syms = Object.keys(prices);
                for (var j = 0; j < syms.length; j++) {
                    if (charts[syms[j]] && charts[syms[j]].history.length === 0) {
                        charts[syms[j]].addPrice(prices[syms[j]]);
                    }
                }
                if (msg.data.players) renderPlayers(msg.data.players);
                appendLog(logTickers, event.data);
            } else if (msg.type === 'TICKER_TICKED') {
                prevPrices[msg.data.symbol] = prices[msg.data.symbol];
                prices[msg.data.symbol] = msg.data.price;
                if (charts[msg.data.symbol]) {
                    charts[msg.data.symbol].addPrice(msg.data.price);
                }
                renderTickers();
                appendLog(logTickers, msg.data.symbol + ' â†’ ' + formatPrice(msg.data.price));
            } else if (msg.type === 'ORDER_FILLED') {
                if (charts[msg.data.symbol]) {
                    charts[msg.data.symbol].addAnnotation(msg.data.side);
                    charts[msg.data.symbol].render();
                }
                appendLog(logEvents, event.data);
            } else {
                appendLog(logEvents, event.data);
            }
        };

        ws.onclose = function() {
            status.textContent = 'Disconnected';
        };

        ws.onerror = function() {
            status.textContent = 'Connection error';
        };

        document.getElementById('logs-toggle').addEventListener('click', function() {
            var logs = document.getElementById('logs');
            var open = logs.classList.toggle('open');
            this.textContent = open ? 'Logs \u25BC' : 'Logs \u25B6';
        });

        document.addEventListener('keydown', function(e) {
            if (!hoveredSymbol || !prices[hoveredSymbol]) return;
            var type = null;
            if (e.key === 'b') type = 'BUY';
            else if (e.key === 's') type = 'SELL';
            if (type) {
                ws.send(JSON.stringify({ type: type, payload: { ticker: hoveredSymbol, price: prices[hoveredSymbol] } }));
            }
        });
    })();
    </script>
</body>
</html>
